# Traces Known - Project Directory Guide

Quick reference for project structure and conventions.

## MCP Servers (AI Assistants)

**Always consult these MCPs before making assumptions:**

| MCP        | Purpose                                      |
| ---------- | -------------------------------------------- |
| `supabase` | Database queries, RLS policies, Supabase API |
| `nextjs`   | Next.js docs, App Router patterns            |
| `context7` | General library documentation lookup         |
| `shadcn`   | UI component patterns and usage              |

These are configured in `.cursor/mcp.json`.

### MCP Workflow (REQUIRED)

1. **Before implementing**: Query relevant MCPs to understand current best practices
   - Next.js features → `nextjs` MCP
   - Database/Supabase → `supabase` MCP
   - Library APIs (drizzle, tRPC, etc.) → `context7` MCP
   - UI components → `shadcn` MCP

2. **After implementing**: Use MCPs to verify your work
   - `supabase`: Check tables, run test queries, verify schema
   - `nextjs`: Use `nextjs_index` to discover running servers, `nextjs_call` to check for errors
   - Start the dev server and use browser automation if needed

3. **When debugging**: Query MCPs for up-to-date error patterns and solutions

**Do not rely on cached knowledge.** Documentation changes. Always verify.

4. **After writing code**: Always run `nextjs_call` with `get_errors` to verify no runtime errors before considering work complete

## Monorepo Structure

```
traces-known/
├── apps/
│   ├── expo/          # React Native mobile app
│   └── nextjs/        # Next.js web app
├── packages/
│   ├── api/           # tRPC routers and procedures
│   ├── auth/          # Authentication (better-auth)
│   ├── db/            # Drizzle ORM, schemas, migrations
│   ├── ui/            # Shared UI components (shadcn/ui)
│   └── validators/    # Shared Zod validators
└── tooling/           # Shared configs (eslint, prettier, tailwind, typescript)
```

## Key Conventions

### Icons

**Use `@radix-ui/react-icons`** - available via `@acme/ui` package dependency.

```tsx
// ✅ Correct
import { ChevronDownIcon, ChevronUpIcon } from "@radix-ui/react-icons";
// ❌ Wrong - lucide-react is NOT a project dependency
import { ChevronDown } from "lucide-react";
```

### UI Components

Import from `@acme/ui`:

```tsx
import { Button, Card, CardContent, Input } from "@acme/ui";
import { Form, FormField, FormItem } from "@acme/ui/form";
import { toast } from "@acme/ui/toast";
```

### Forms (TanStack Form)

Use TanStack Form with the Field UI components from `@acme/ui`:

```tsx
import { useForm } from "@tanstack/react-form";
import { Field, FieldError, FieldLabel } from "@acme/ui";

function MyForm() {
  const form = useForm({
    defaultValues: { email: "" },
    onSubmit: async ({ value }) => { /* handle submit */ },
  });

  return (
    <form onSubmit={(e) => { e.preventDefault(); void form.handleSubmit(); }}>
      <form.Field
        name="email"
        validators={{
          onChange: ({ value }) => !value ? "Email is required" : undefined,
        }}
      >
        {(field) => {
          const isInvalid = field.state.meta.isTouched && !field.state.meta.isValid;
          return (
            <Field data-invalid={isInvalid}>
              <FieldLabel htmlFor={field.name}>Email</FieldLabel>
              <Input
                id={field.name}
                name={field.name}
                value={field.state.value}
                onBlur={field.handleBlur}
                onChange={(e) => field.handleChange(e.target.value)}
              />
              {isInvalid && <FieldError errors={field.state.meta.errors as string[]} />}
            </Field>
          );
        }}
      </form.Field>

      <form.Subscribe selector={(state) => [state.canSubmit, state.isSubmitting]}>
        {([canSubmit, isSubmitting]) => (
          <Button type="submit" disabled={!canSubmit || isSubmitting}>
            {isSubmitting ? "Submitting..." : "Submit"}
          </Button>
        )}
      </form.Subscribe>
    </form>
  );
}
```

For Next.js server actions, use `@tanstack/react-form-nextjs`:

```tsx
import { initialFormState, mergeForm, useForm, useTransform } from "@tanstack/react-form-nextjs";
```

### Database / Schema

- Schemas live in `packages/db/src/schema/`
- Relations consolidated in `relations.ts` (one `relations()` call per table)
- Use Drizzle ORM with Supabase
- **Database schema name is `app`** (not `public`) - tables are `app.product`, `app.user`, etc.

### Adding New Database Tables (IMPORTANT)

When creating a new schema file in `packages/db/src/schema/`:

1. **Create the schema file** (e.g., `my-table-schema.ts`)
2. **Export from index.ts** - Add `export * from "./my-table-schema";` to `packages/db/src/schema/index.ts`
3. **Register in client.ts** - Add import AND spread in schema object in `packages/db/src/client.ts`:
   ```ts
   import * as myTableSchema from "./schema/my-table-schema";
   // ...
   export const db = drizzle(client, {
     schema: {
       ...myTableSchema,  // ADD THIS
       ...relations,
     },
   });
   ```
4. **Add relations** - Update `packages/db/src/schema/relations.ts` with new table relations
5. **Apply migration** - Use Supabase MCP to create tables and RLS policies

**Forgetting step 3 causes `Cannot read properties of undefined (reading 'findMany')` errors.**

### Hydration Safety

Use `formatDate()` from `~/lib/user` instead of `toLocaleDateString()` to avoid server/client hydration mismatches:

```tsx
// ❌ Causes hydration mismatch
{new Date(date).toLocaleDateString()}

// ✅ Consistent across server and client  
import { formatDate } from "~/lib/user";
{formatDate(date)}
```

### API (tRPC)

- Routers in `packages/api/src/router/`
- Root router in `packages/api/src/root.ts`
- Use `publicProcedure` or `protectedProcedure` from `../trpc`

### Package Rebuilds (IMPORTANT)

**After modifying any file in `packages/`**, you must rebuild for types to propagate:

```bash
pnpm build --filter=@acme/api   # After changing API/tRPC routers
pnpm build --filter=@acme/db    # After changing schemas/relations
pnpm build --filter=@acme/ui    # After changing UI components
```

Or rebuild all packages:

```bash
pnpm build --filter="./packages/*"
```

**After rebuilding**, restart TypeScript server in Cursor: `Cmd+Shift+P` → "TypeScript: Restart TS Server"

Without rebuilding, consuming apps (e.g., `apps/nextjs`) will show type errors.

### Authentication

- Uses `better-auth`
- Server: `~/auth/server` → `getSession()`
- Client: `~/auth/client` → `authClient`

### Data Fetching (Next.js)

- tRPC via React Query
- Use `useSuspenseQuery` for data in Suspense boundaries
- Use `useQuery` for optional/conditional data
- Access tRPC: `const trpc = useTRPC();`

## Package Aliases

| Alias              | Path                     |
| ------------------ | ------------------------ |
| `@acme/ui`         | `packages/ui`            |
| `@acme/db`         | `packages/db`            |
| `@acme/db/schema`  | `packages/db/src/schema` |
| `@acme/api`        | `packages/api`           |
| `@acme/auth`       | `packages/auth`          |
| `@acme/validators` | `packages/validators`    |

## Next.js App Structure

```
apps/nextjs/src/
├── app/
│   ├── _actions/      # Server actions
│   ├── _components/   # Page-specific components
│   ├── api/           # API routes (tRPC, auth)
│   └── [routes]/      # Page routes
├── auth/              # Auth client/server exports
├── lib/               # Utilities
└── trpc/              # tRPC client setup
```
